name: Build and Deploy

on:
  push:
    branches: ["master"]

  workflow_dispatch:

# If a workflow run is in progress, cancel it
concurrency:
  group: production
  cancel-in-progress: true
  
env:
  NODE_ENV: production
  BUILD_PATH: .

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install pnpm
        run: npm install -g pnpm

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: '18'

          
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Check if SSH is working
        run: ssh -p ${{secrets.SSH_PORT}} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "echo 'SSH is working'"

      - name: Restore cached npm dependencies
        id: cache-dependencies-restore
        uses: actions/cache/restore@v3
        with:
          path: |
            node_modules
          key: npm-dependencies-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Dependencies
        run: pnpm i

      - name: Cache npm dependencies
        id: cache-dependencies-save
        uses: actions/cache/save@v3
        with:
          path: |
            node_modules
          key: ${{ steps.cache-dependencies-restore.outputs.cache-primary-key }}

      - name: Build
        run: pnpm run build

      - name: Make entry script executable
        run: chmod +x ./BlogWebExpressServer.sh
          
      - name: Transfer and delete if not same
        run: |
          rsync -av --delete dist/ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/root/blog-web
          rsync -av --delete BlogWebExpressServer.sh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/root/blog-web
          rsync -av --delete express.js ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/root/blog-web

      - name: Restart Express server
        run: |
          ssh -p ${{secrets.SSH_PORT}} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "systemctl restart blog-web.service"
            